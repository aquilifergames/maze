<!doctype html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Safe Zone</title>
    <script src="phaser.js"></script>
    <script src="visibility_polygon.js"></script>
</head>

<body>
    <script type="text/javascript">
    window.onload = function() {

        var game = new Phaser.Game(770, 770, Phaser.CANVAS, '', {
            preload: preload,
            create: create,
            update: update,
            render: render
        });
        var map;
        var mainCharacter;
        var colissionLayer;

        // the canvas where we will show the obstaclesCanvas
        var obstaclesCanvas;
        // the canvas where we will show the light
        var lightCanvas;
        // number of boxes on the stage
        var numBoxes = 15;
        // array which will store all polygons
        var polygons = [];

        function preload() {
            game.physics.startSystem(Phaser.Physics.ARCADE);
            game.load.tilemap('map', 'assets/map2.json', null, Phaser.Tilemap.TILED_JSON);
            game.load.image('mainCharacter', 'assets/ball.png');
            game.load.image('tiles', 'assets/tilesheet_complete.png');
        }

        function create() {
            map = game.add.tilemap('map');
            map.addTilesetImage('tilesheet_complete', 'tiles');
            map.createLayer('fondo');
            colissionLayer = map.createLayer('colision');

            for (var y = 0; y < map.height; ++y) {
                for (var x = 0; x < map.width; ++x) {
                    var tile = map.getTile(x, y, "colision");
                    if (tile != null) {
                        console.log(tile);

                        polygons.push([
                            [tile.worldX, tile.worldY],
                            [tile.worldX + tile.width, tile.worldY],
                            [tile.worldX + tile.width, tile.worldY + tile.height],
                            [tile.worldX, tile.worldY + tile.height]
                        ]);

                    }
                }
            }

            map.setCollision([0, 93], true, colissionLayer);
            game.physics.arcade.enable(colissionLayer);

            mainCharacter = game.add.sprite(95, 95, 'mainCharacter');
            game.physics.arcade.enable(mainCharacter);

            mainCharacter.body.collideWorldBounds = true;
            mainCharacter.body.setSize(30, 30);
            mainCharacter.anchor.set(0.5);

            // listener to mouse movement       
            moveIndex = game.input.addMoveCallback(move, this);
            // the canvas where we will show the obstaclesCanvas
            obstaclesCanvas = game.add.graphics(0, 0);
            // line style of obstacle canvas
            obstaclesCanvas.lineStyle(4, 0xffffff, 1);
            // the canvas where we will display the scene
            lightCanvas = game.add.graphics(0, 0);
            
            // placing the perimeter box
            polygons.push([
                [-1, -1],
                [game.width + 1, -1],
                [game.width + 1, game.height + 1],
                [-1, game.height + 1]
            ]);
        }

        function update() {
            game.physics.arcade.collide(mainCharacter, colissionLayer);
            cursors = game.input.keyboard.createCursorKeys();

            mainCharacter.body.velocity.x = 0;
            mainCharacter.body.velocity.y = 0;

            if (cursors.left.isDown) {
                mainCharacter.body.velocity.x = -150;
            }

            if (cursors.right.isDown) {
                mainCharacter.body.velocity.x = 150;
            }

            if (cursors.up.isDown) {
                mainCharacter.body.velocity.y = -150;
            }

            if (cursors.down.isDown) {
                mainCharacter.body.velocity.y = 150;
            }
        }

        function render() {
            game.debug.body(mainCharacter);

        }

        function move() {
            // when the mouse is moved, we determine the new visibility polygon     
            var visibility = createLightPolygon(game.input.worldX, game.input.worldY);
            // then we draw it
            lightCanvas.clear();
            lightCanvas.lineStyle(2, 0xff8800, 1);
            lightCanvas.beginFill(0xffff00);
            lightCanvas.moveTo(visibility[0][0], visibility[0][1]);
            for (var i = 1; i <= visibility.length; i++) {
                lightCanvas.lineTo(visibility[i % visibility.length][0], visibility[i % visibility.length][1]);
            }
            lightCanvas.endFill();
        }

        // and this is how the library generates the visibility polygon starting
        // from an array of polygons and a source point
        function createLightPolygon(x, y) {
            var segments = VisibilityPolygon.convertToSegments(polygons);
            segments = VisibilityPolygon.breakIntersections(segments);
            var position = [x, y];
            if (VisibilityPolygon.inPolygon(position, polygons[polygons.length - 1])) {
                return VisibilityPolygon.compute(position, segments);
            }
            return null;
        }
    };
    </script>
</body>

</html>
