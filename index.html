<!doctype html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Safe Zone</title>
    <script src="phaser.js"></script>
    <script src="visibility_polygon.js"></script>
</head>

<body>
    <script type="text/javascript">
    window.onload = function() {

        var game = new Phaser.Game(770, 770, Phaser.CANVAS, '', {
            preload: preload,
            create: create,
            update: update,
            render: render
        });
        var map;
        var mainCharacter;
        var colissionLayer;

        var lightCanvas;
        var polygons = [];

        function preload() {
            game.physics.startSystem(Phaser.Physics.ARCADE);
            game.load.tilemap('map', 'assets/map2.json', null, Phaser.Tilemap.TILED_JSON);
            game.load.image('mainCharacter', 'assets/ball.png');
            game.load.image('tiles', 'assets/tilesheet_complete.png');
        }

        function create() {
            map = game.add.tilemap('map');
            map.addTilesetImage('tilesheet_complete', 'tiles');
            map.createLayer('fondo');
            colissionLayer = map.createLayer('colision');

            map.setCollision([0, 93], true, colissionLayer);
            game.physics.arcade.enable(colissionLayer);

            mainCharacter = game.add.sprite(95, 95, 'mainCharacter');
            game.physics.arcade.enable(mainCharacter);

            mainCharacter.body.collideWorldBounds = true;
            mainCharacter.body.setSize(30, 30);
            mainCharacter.anchor.set(0.5);

            pushBlocks();
            // the canvas where we will display the scene
            lightCanvas = game.add.graphics(0, 0);
        }

        function update() {
            game.physics.arcade.collide(mainCharacter, colissionLayer);
            cursors = game.input.keyboard.createCursorKeys();

            mainCharacter.body.velocity.x = 0;
            mainCharacter.body.velocity.y = 0;
            velocity = 250;

            if (cursors.left.isDown) {
                mainCharacter.body.velocity.x = -velocity;
            }

            if (cursors.right.isDown) {
                mainCharacter.body.velocity.x = velocity;
            }

            if (cursors.up.isDown) {
                mainCharacter.body.velocity.y = -velocity;
            }

            if (cursors.down.isDown) {
                mainCharacter.body.velocity.y = velocity;
            }

            move(mainCharacter);
        }

        function render() {
            game.debug.body(mainCharacter);
        }

        function move() {
            // when the mouse is moved, we determine the new visibility polygon     
            var visibility = createLightPolygon(mainCharacter.x, mainCharacter.y);
            // then we draw it
            lightCanvas.clear();
            lightCanvas.lineStyle(0, 0xff8800);
            lightCanvas.beginFill(0xffffff, 0.6);
            lightCanvas.moveTo(visibility[0][0], visibility[0][1]);
            for (var i = 1; i <= visibility.length; i++) {
                lightCanvas.lineTo(visibility[i % visibility.length][0], visibility[i % visibility.length][1]);
            }
            lightCanvas.endFill();
        }

        // and this is how the library generates the visibility polygon starting
        // from an array of polygons and a source point
        function createLightPolygon(x, y) {
            var segments = VisibilityPolygon.convertToSegments(polygons);
            segments = VisibilityPolygon.breakIntersections(segments);
            var position = [x, y];
            if (VisibilityPolygon.inPolygon(position, polygons[polygons.length - 1])) {
                return VisibilityPolygon.compute(position, segments);
            }
            return null;
        }

        function pushBlocks() {
            for (var y = 0; y < map.height; ++y) {
                for (var x = 0; x < map.width; ++x) {
                    var tile = map.getTile(x, y, "colision");
                    if (tile != null) {
                        polygons.push([
                            [tile.worldX, tile.worldY],
                            [tile.worldX + tile.width, tile.worldY],
                            [tile.worldX + tile.width, tile.worldY + tile.height],
                            [tile.worldX, tile.worldY + tile.height]
                        ]);

                    }
                }
            }

            //Set perimetral view
            polygons.push([
                [-1, -1],
                [game.width + 1, -1],
                [game.width + 1, game.height + 1],
                [-1, game.height + 1]
            ]);
        }
    };
    </script>
</body>

</html>
