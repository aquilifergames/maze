<!doctype html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Safe Zone</title>
    <script src="phaser.js"></script>
    <script src="visibility_polygon.js"></script>
</head>

<body>
    <script type="text/javascript">
    window.onload = function() {

        var game = new Phaser.Game(770, 770, Phaser.CANVAS, '', {
            preload: preload,
            create: create,
            update: update,
            render: render
        });
        var map;
        var mainCharacter;
        var colissionLayer;
        var safeZones;
        var background;
        var exit;

        var lightCanvas;
        var background;
        var polygons = [];

        var light = 200;
        var lightText;

        var gameOver = false;

        function preload() {
            game.time.advancedTiming = true;
            game.physics.startSystem(Phaser.Physics.ARCADE);
            //Magic
            //game.world.setBounds(0,0,2000,2000);
            game.load.tilemap('map', 'assets/map3.json', null, Phaser.Tilemap.TILED_JSON);
            game.load.image('mainCharacter', 'assets/ball.png');
            game.load.image('szone', 'assets/greenFire.png');
            game.load.image('exit', 'assets/exit.png');
            game.load.image('tiles', 'assets/tilesheet_complete.png');
        }

        function create() {
            map = game.add.tilemap('map');
            map.addTilesetImage('tilesheet_complete', 'tiles');
            background = map.createLayer('fondo');
            colissionLayer = map.createLayer('colision');

            map.setCollision([0, 93], true, colissionLayer);
            game.physics.arcade.enable(colissionLayer);

            safeZones = game.add.group();
            safeZones.enableBody = true;
            map.createFromObjects('zona-carga', 401, 'szone', 0, true, false, safeZones);


            exit = game.add.group();
            exit.enableBody=true;
            map.createFromObjects('exit', 20, 'exit', 0, true, false, exit);

            mainCharacter = game.add.sprite(95, 95, 'mainCharacter');
            game.physics.arcade.enable(mainCharacter);

            //mainCharacter.body.collideWorldBounds = true;
            mainCharacter.body.setSize(30, 30);
            mainCharacter.anchor.set(0.5);
            //descomentar para que la camara te siga junto con la linea "Magic"
            //game.camera.follow(mainCharacter);
            // the canvas where we will display the scene
            pushBlocks();
            // the canvas where we will display the scene
            lightCanvas = game.add.graphics(0, 0);
            background.mask = lightCanvas;
            colissionLayer.mask = lightCanvas;
            safeZones.mask = lightCanvas;
            exit.mask = lightCanvas;

            game.time.events.loop(500, updateLight, this);

            lightText = game.add.text(game.world.centerX - 200,5    , 'Remaining Light 300', { font: "25px Arial", fill: "#ffffff", align: "top" });
        }

        function update() {
            game.physics.arcade.collide(mainCharacter, colissionLayer);
            game.physics.arcade.overlap(mainCharacter, safeZones, charge, null, this);
            game.physics.arcade.overlap(mainCharacter, exit, finishLevel, null, this);
            cursors = game.input.keyboard.createCursorKeys();

            mainCharacter.body.velocity.x = 0;
            mainCharacter.body.velocity.y = 0;
            velocity = 250;

            if (cursors.left.isDown) {
                mainCharacter.body.velocity.x = -velocity;
            }

            else if (cursors.right.isDown) {
                mainCharacter.body.velocity.x = velocity;
            }

            else if (cursors.up.isDown) {
                mainCharacter.body.velocity.y = -velocity;
            }

            else if (cursors.down.isDown) {
                mainCharacter.body.velocity.y = velocity;
            }

            
            //background.alpha = 0.5 + Math.random() * 0.5;
        }

        function updateLight(){
            light = light -10;
            lightText.setText('Remaining Light ' + light);
            if(light == 0) gameOver = true;
        }

        function render() {
            //game.debug.body(mainCharacter);
            move(mainCharacter);
        }

        function move() {
            // when the mouse is moved, we determine the new visibility polygon     
            var visibility = createLightPolygon(mainCharacter.x, mainCharacter.y);
            // then we draw it
            lightCanvas.clear();

            lightCanvas.lineStyle(2, 0xffffff, 0.5);
            lightCanvas.beginFill(0xffff00);
            lightCanvas.moveTo(visibility[0][0], visibility[0][1]);
            for (var i = 1; i <= visibility.length; i++) {
                lightCanvas.lineTo(visibility[i % visibility.length][0], visibility[i % visibility.length][1]);
            }
            lightCanvas.endFill();
        }
        function charge(){
            if (light <= 200) {
                light += 10;    
            }
            
        }

        function finishLevel(){console.log("finishLevel");}

        // and this is how the library generates the visibility polygon starting
        // from an array of polygons and a source point
        function createLightPolygon(x, y) {
            var segments = VisibilityPolygon.convertToSegments(polygons);
            //segments = VisibilityPolygon.breakIntersections(segments);
            var position = [x, y];
            ////if (VisibilityPolygon.inPolygon(position, polygons[polygons.length - 1])) {
             //   return VisibilityPolygon.compute(position, segments);
            //}
            return VisibilityPolygon.compute(position, segments);;
        }

        function pushBlocks() {
            for (var y = 0; y < map.height; ++y) {
                for (var x = 0; x < map.width; ++x) {
                    var tile = map.getTile(x, y, "colision");
                    if (tile != null) {
                        polygons.push([
                            [tile.worldX, tile.worldY],
                            [tile.worldX + tile.width, tile.worldY],
                            [tile.worldX + tile.width, tile.worldY + tile.height],
                            [tile.worldX, tile.worldY + tile.height]
                        ]);

                    }
                }
            }

            //Set perimetral view
            //polygons.push([
             //   [-1, -1],
              //  [game.width + 1, -1],
              //  [game.width + 1, game.height + 1],
              //  [-1, game.height + 1]
           // ]);
        }
    };
    </script>
</body>

</html>
